---
apiVersion: v1
kind: ConfigMap
metadata:
  name: logstash-config
  namespace: logging
  labels:
    app: logstash
    component: logging
data:
  logstash.yml: |-
    http.host: "0.0.0.0"
    path.config: /usr/share/logstash/pipeline
    xpack.monitoring.enabled: true
    xpack.monitoring.elasticsearch.hosts: ["http://elasticsearch-master:9200"]
    
  logstash.conf: |-
    input {
      beats {
        port => 5044
      }
    }
    
    filter {
      # Parse JSON logs
      if [message] =~ /^\{.*\}$/ {
        json {
          source => "message"
          target => "parsed_json"
        }
      }
      
      # Extract Kubernetes metadata
      if [kubernetes] {
        mutate {
          add_field => {
            "service_name" => "%{[kubernetes][labels][app]}"
            "namespace" => "%{[kubernetes][namespace]}"
            "pod_name" => "%{[kubernetes][pod][name]}"
            "container_name" => "%{[kubernetes][container][name]}"
          }
        }
      }
      
      # Parse log level from message
      grok {
        match => {
          "message" => [
            "%{TIMESTAMP_ISO8601:log_timestamp}\s+%{LOGLEVEL:log_level}\s+%{GREEDYDATA:log_message}",
            "\[%{TIMESTAMP_ISO8601:log_timestamp}\]\s+%{LOGLEVEL:log_level}\s+%{GREEDYDATA:log_message}",
            "%{LOGLEVEL:log_level}\s+%{TIMESTAMP_ISO8601:log_timestamp}\s+%{GREEDYDATA:log_message}",
            "level=%{LOGLEVEL:log_level}\s+ts=%{TIMESTAMP_ISO8601:log_timestamp}\s+%{GREEDYDATA:log_message}"
          ]
        }
        tag_on_failure => ["_grokparsefailure"]
      }
      
      # Extract endpoint and latency from log message
      grok {
        match => {
          "log_message" => [
            "(?<endpoint>/[^\s]*)\s+.*latency[=:]?\s*(?<latency_ms>\d+)ms",
            "(?<http_method>GET|POST|PUT|DELETE|PATCH)\s+(?<endpoint>/[^\s]*)\s+.*(?<latency_ms>\d+)ms",
            "path=(?<endpoint>/[^\s]*)\s+.*duration=(?<latency_ms>\d+)ms"
          ]
        }
        tag_on_failure => []
      }
      
      # Convert latency to number
      if [latency_ms] {
        mutate {
          convert => { "latency_ms" => "integer" }
        }
      }
      
      # Normalize log level
      if [log_level] {
        mutate {
          uppercase => [ "log_level" ]
        }
      }
      
      # Add environment tag
      mutate {
        add_field => { "environment" => "staging" }
      }
      
      # Parse timestamp
      if [log_timestamp] {
        date {
          match => [ "log_timestamp", "ISO8601" ]
          target => "@timestamp"
        }
      }
      
      # Remove unnecessary fields
      mutate {
        remove_field => [ "agent", "ecs", "input", "log", "host" ]
      }
    }
    
    output {
      elasticsearch {
        hosts => ["http://elasticsearch-master:9200"]
        index => "app-logs-staging-%{+YYYY.MM.dd}"
        manage_template => true
        template_name => "app-logs"
        template_overwrite => true
      }
      
      # Debug output (opcional - comentar em produção)
      # stdout { codec => rubydebug }
    }

